(()=>{"use strict";var t={};function e(){const t=new Date;return`${t.toLocaleDateString()} ${t.toLocaleTimeString()}`}t.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),(()=>{var e;t.g.importScripts&&(e=t.g.location+"");var i=t.g.document;if(!e&&i&&(i.currentScript&&(e=i.currentScript.src),!e)){var s=i.getElementsByTagName("script");if(s.length)for(var o=s.length-1;o>-1&&!e;)e=s[o--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),t.p=e})();const i=t.p+"videos/videoOne.mp4",s=t.p+"videos/System_Of_A_Down-Aerials.mp4",o=t.p+"levoe-uho-pravoe-uho-centr.mp3";const n=document.querySelector("#hw"),a=new class{constructor(){this.container=null,this.textSubmitListeners=[],this.popUpSubmitListeners=[],this.audioClickListeners=[],this.videoClickListeners=[],this.mediaOkListeners=[],this.mediaCancelListeners=[],this.targetMedia=null}bindToDOM(t){if(!(t instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=t}checkBinding(){if(null===this.container)throw new Error("ListEditPlay not bind to DOM")}drawUI(){this.checkBinding(),this.container.innerHTML='\n        <header class="header">\n          <p>–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ –∫ –∑–∞–Ω—è—Ç–∏—é "10. Geolocation, Notification, Media"</p>\n          <p>Timeline</p>\n        </header>\n        <div class="timeline-container">\n          <div class="timeline"></div>\n          <form class="timeline-form">\n            <input class="timeline-body-message"/>\n            <div class="timeline-btns">\n              <button class="timeline-btn close" data-id="media-ok" type="button">‚úî</button>\n              <div class="timeline-media-info close" data-id="media-info">00:00</div>\n              <button class="timeline-btn close" data-id="media-cancel" type="button">‚úò</button>\n              <button class="timeline-btn" data-id="audio" type="button">üéôÔ∏è</button>\n              <button class="timeline-btn" data-id="video" type="button">üé•</button>\n              <button class="timeline-btn" data-id="text" type="submit">‚úâ</button>\n            </div>\n          </form>\n          <form class="popup close">\n            <div class="popup-container">\n              <div class="popup-header">–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫</div>\n              <div class="popup-text">\n                –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–∞–º –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ, \n                –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–∞–π—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏, \n                –ª–∏–±–æ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤—Ä—É—á–Ω—É—é.\n              </div>\n              <div class="popup-text">–®–∏—Ä–æ—Ç–∞ –∏ –¥–æ–ª–≥–æ—Ç–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é</div>\n              <input type="text" class="popup-geo"/>\n              <div class="popup-buttons">\n                <button class="popup-btn" data-id="popup-submit" type="submit" autofocus>–û–ö</button>\n                <button class="popup-btn" data-id="popup-cansel" type="cancel">–û—Ç–º–µ–Ω–∞</button>\n              </div>\n            </div>\n          </form>\n        </div>\n      ',this.timeline=this.container.querySelector(".timeline"),this.timelineForm=this.container.querySelector(".timeline-form"),this.timelineBody=this.container.querySelector(".timeline-body-message"),this.popUp=this.container.querySelector(".popup"),this.popUpGeoText=this.container.querySelector(".popup-geo"),this.btnMediaOk=this.container.querySelector('[data-id="media-ok"]'),this.btnMediaInfo=this.container.querySelector('[data-id="media-info"]'),this.btnMediaCancel=this.container.querySelector('[data-id="media-cancel"]'),this.btnAudio=this.container.querySelector('[data-id="audio"]'),this.btnVideo=this.container.querySelector('[data-id="video"]'),this.btnText=this.container.querySelector('[data-id="text"]'),this.timelineForm.addEventListener("submit",(t=>this.onTextSubmit(t))),this.btnAudio.addEventListener("click",(t=>this.onAudioClick(t))),this.btnVideo.addEventListener("click",(t=>this.onVideoClick(t))),this.btnText.addEventListener("click",(t=>this.onTextSubmit(t))),this.timelineBody.addEventListener("focus",(()=>this.onFocusClear("timelineBody"))),this.popUpGeoText.addEventListener("focus",(()=>this.onFocusClear("popUpGeoText"))),this.btnMediaOk.addEventListener("click",(t=>this.onMediaOk(t))),this.btnMediaCancel.addEventListener("click",(t=>this.onMediaCancel(t))),this.popUp.addEventListener("submit",(t=>this.onPopUpSubmit(t)))}renderMessage(t){const{date:e,geo:i,body:s,type:o}=t;if("audio"!==o&&"video"!==o&&"text"!==o)return;const n=document.createElement("div");n.classList.add("message-container");const a=document.createElement("div");a.classList.add("message");const d=document.createElement("div");d.classList.add("message-date"),d.textContent=e;const r=document.createElement("div");if(r.classList.add("message-body"),"audio"===o||"video"===o){const t=document.createElement(o);t.controls=!0,t.preload="auto",t.classList.add(o),t.src=s,r.appendChild(t)}"text"===o&&(r.textContent=s);const c=document.createElement("div");c.classList.add("message-geo"),c.textContent=`${i} üëÅ`,n.appendChild(a),a.appendChild(d),a.appendChild(r),a.appendChild(c),this.timeline.prepend(n),this.timeline.scrollTo(0,-99999)}addTextSubmitListeners(t){this.textSubmitListeners.push(t)}onTextSubmit(t){t.preventDefault();const e=this.timelineBody.value;this.timelineBody.value="",this.textSubmitListeners.forEach((t=>t.call(null,e)))}addPopUpSubmitListeners(t){this.popUpSubmitListeners.push(t)}onPopUpSubmit(t){t.preventDefault();const e=t.submitter.dataset.id,i=this.popUpGeoText.value;this.popUpSubmitListeners.forEach((t=>t.call(null,{dataID:e,geoStr:i})))}addAudioClickListeners(t){this.audioClickListeners.push(t)}onAudioClick(t){t.preventDefault(),this.audioClickListeners.forEach((t=>t.call(null,"")))}addMediaOkListeners(t){this.mediaOkListeners.push(t)}onMediaOk(t){t.preventDefault(),this.mediaOkListeners.forEach((t=>t.call(null,"")))}addMediaCancelListeners(t){this.mediaCancelListeners.push(t)}onMediaCancel(t){t.preventDefault(),this.mediaCancelListeners.forEach((t=>t.call(null,"")))}addVideoClickListeners(t){this.videoClickListeners.push(t)}onVideoClick(t){t.preventDefault(),this.videoClickListeners.forEach((t=>t.call(null,"")))}setTimeMediaInfo(t){const e=Math.floor(t/60),i=t%60,s=`${String(e).padStart(2,"0")}:${String(i).padStart(2,"0")}`;this.btnMediaInfo.textContent=s}createStreamVideo(t){this.watchVideo=document.createElement("video"),this.watchVideo.classList.add("stream"),this.watchVideo.srcObject=t,this.watchVideo.muted=!0,this.timelineForm.appendChild(this.watchVideo),this.watchVideo.play()}removeStreamVideo(){void 0!==this.watchVideo&&this.watchVideo.remove()}mediaOpenMedia(){this.timelineBody.setAttribute("readonly","true"),this.timelineBody.classList.add("read-only"),this.btnMediaOk.classList.remove("close"),this.btnMediaInfo.classList.remove("close"),this.btnMediaCancel.classList.remove("close"),this.btnAudio.classList.add("close"),this.btnVideo.classList.add("close"),this.btnText.classList.add("close")}mediaCloseMedia(){this.timelineBody.removeAttribute("readonly"),this.timelineBody.classList.remove("read-only"),this.btnMediaOk.classList.add("close"),this.btnMediaInfo.classList.add("close"),this.btnMediaCancel.classList.add("close"),this.btnAudio.classList.remove("close"),this.btnVideo.classList.remove("close"),this.btnText.classList.remove("close")}message(t,e){this[t].placeholder=e}onFocusClear(t){this.message(t,""),this[t].classList.remove("error-add")}errorInputAdd(t,e){this[t].value="",this.message(t,e),this[t].classList.add("error-add")}popupOpen(){this.message("popUpGeoText","00.00000, 00.00000"),this.popUp.classList.remove("close")}popupClose(){this.onFocusClear("popUpGeoText"),this.popUpGeoText.value="",this.popUp.classList.add("close")}};a.bindToDOM(n);const d=new class{constructor(){this.status=!1}checkSupportGEO(){navigator.geolocation&&(this.status=!0)}async getPosition(){if(!this.status)return!1;try{return await new Promise(((t,e)=>{navigator.geolocation.getCurrentPosition((e=>{const{latitude:i,longitude:s}=e.coords;t({latitude:i,longitude:s,status:!0})}),(t=>{e(t)}),{enableHighAccuracy:!0})}))}catch(t){return console.error("Error getting  geolocation:",t),!1}}},r=new class{constructor(t="TimelineMemory"){this.storageKey=t,this.data=this.loadFromStorage()}init(){const t=[{date:"04.08.2023 16:18:22",body:"—ç—Ç–æ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è 1",geo:"[51.312312, -0.12321]",type:"text"},{date:"08.08.2023 20:22:26",body:i,geo:"[55.312312, -0.12321]",type:"video"},{date:"12.08.2023 17:19:23",body:o,geo:"[52.312312, -0.12321]",type:"audio"},{date:"13.10.2023 20:22:26",body:s,geo:"[55.312312, -0.12321]",type:"video"}];if(0===this.data.length)for(let e=0;e<t.length;e+=1)this.addItem(t[e])}loadFromStorage(){const t=localStorage.getItem(this.storageKey);return t?JSON.parse(t):[]}saveToStorage(){localStorage.setItem(this.storageKey,JSON.stringify(this.data))}addItem(t){this.data.push(t),this.saveToStorage()}getAllItems(){return this.data}removeItem(t){t>=0&&t<this.data.length&&(this.data.splice(t,1),this.saveToStorage())}clear(){this.data=[],localStorage.removeItem(this.storageKey)}},c=new class{constructor(){this.stream=null,this.mediaRecorder=null,this.chunks=[],this.type=null,this.status=!0}async startRecording(t){this.chunks=[],t.video||(this.type="audio"),t.video&&(this.type="video");try{const e=t.audio||!1,i=t.width||640,s=t.height||480,o={audio:e,video:!!t.video&&{width:i,height:s}};return this.stream=await navigator.mediaDevices.getUserMedia(o),this.mediaRecorder=new MediaRecorder(this.stream),this.mediaRecorder.ondataavailable=t=>{t.data.size>0&&this.chunks.push(t.data)},this.mediaRecorder.start(),this.stream}catch(t){return this.status=!1,console.error("Error starting recording:",t),!1}}stopRecording(){this.status&&this.mediaRecorder&&"inactive"!==this.mediaRecorder.state&&(this.mediaRecorder.stop(),this.stream.getTracks().forEach((t=>t.stop())))}async getRecordingAsBlob(){return!!this.status&&new Promise(((t,e)=>{this.mediaRecorder.onstop=()=>{if(0===this.chunks.length)return void e(new Error("No data recorded."));const i=new Blob(this.chunks,{type:this.stream.getTracks()[0].kind}),s=URL.createObjectURL(i),{type:o}=this;t({url:s,type:o})}}))}},l=new class{constructor(t,e,i,s){this.timelineDOM=t,this.timelineGEO=e,this.storage=i,this.recorder=s,this.lastMessage={}}init(){this.storage.init(),this.timelineDOM.drawUI(),this.timelineGEO.checkSupportGEO(),this.timelineDOM.addTextSubmitListeners(this.onTextSubmit.bind(this)),this.timelineDOM.addPopUpSubmitListeners(this.onPopUpSubmit.bind(this)),this.timelineDOM.addVideoClickListeners(this.onVideoClick.bind(this)),this.timelineDOM.addAudioClickListeners(this.onAudioClick.bind(this)),this.timelineDOM.addMediaOkListeners(this.onMediaOk.bind(this)),this.timelineDOM.addMediaCancelListeners(this.onMediaCancel.bind(this));const t=this.storage.getAllItems();for(let e=0;e<t.length;e+=1)this.timelineDOM.renderMessage(t[e])}async onTextSubmit(t){if(!t)return void this.timelineDOM.errorInputAdd("timelineBody","–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç");const i=e();this.sendPostWithGeo({date:i,body:t,type:"text"})}async mediaStartRecord(t,e){this.timelineDOM.onFocusClear("timelineBody");const i=await this.recorder.startRecording(t);if(!i)return void this.timelineDOM.errorInputAdd("timelineBody",e);this.timelineDOM.mediaOpenMedia();let s=0;this.timelineDOM.setTimeMediaInfo(s),this.secondMediaID=setInterval((()=>{s+=1,this.timelineDOM.setTimeMediaInfo(s)}),1e3),t.video&&this.timelineDOM.createStreamVideo(i)}async onAudioClick(){this.mediaStartRecord({audio:!0},"—Ä–∞–∑—Ä–µ—à–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –∏ –∫–∞–º–µ—Ä—ã")}async onVideoClick(){this.mediaStartRecord({audio:!0,video:!0},"—Ä–∞–∑—Ä–µ—à–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –∏ –∫–∞–º–µ—Ä—ã")}async onPopUpSubmit(t){const{dataID:i,geoStr:s}=t;if(i&&("popup-cansel"===i&&this.timelineDOM.popupClose(),"popup-submit"===i)){const t={date:e(),body:this.lastMessage.body,type:this.lastMessage.type};if(""===s){t.post=!0;if(await this.sendPostWithGeo(t))return void this.timelineDOM.popupClose()}const i=function(t){if(!t)return!1;const e=/(-?\d+\.\d+)/g;if(/^(\[(-?\d+\.\d+),\s?(-?\d+\.\d+)\]|(-?\d+\.\d+),\s?(-?\d+\.\d+))$/.test(t)){const i=t.match(e),s=parseFloat(i[0]),o=parseFloat(i[1]);return!!(s>-90&&s<90&&o>-180&&o<180)&&{latitude:s,longitude:o}}return!1}(s);if(!i)return void this.timelineDOM.errorInputAdd("popUpGeoText","–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç [00.00000, 00.00000]");i&&(this.timelineDOM.popupClose(),t.geo=`[${i.latitude.toFixed(5)}, ${i.longitude.toFixed(5)}]`,this.storage.addItem(t),this.timelineDOM.renderMessage(t))}}async onMediaOk(){clearInterval(this.secondMediaID),this.timelineDOM.mediaCloseMedia();const t=e();this.recorder.stopRecording();const{url:i,type:s}=await this.recorder.getRecordingAsBlob();"video"===s&&this.timelineDOM.removeStreamVideo(),this.sendPostWithGeo({date:t,body:i,type:s})}onMediaCancel(){clearInterval(this.secondMediaID),this.recorder.stopRecording(),this.timelineDOM.mediaCloseMedia(),this.timelineDOM.removeStreamVideo()}async sendPostWithGeo(t){const e=t,i=await this.timelineGEO.getPosition();if(i&&i.status){const{latitude:t,longitude:s}=i;return e.geo=`[${parseFloat(t.toFixed(5))}, ${parseFloat(s.toFixed(5))}]`,this.storage.addItem(e),this.timelineDOM.renderMessage(e),!0}return i||e.form||(this.lastMessage=e,this.timelineDOM.popupOpen()),!1}}(a,d,r,c);l.init(),console.log("app started")})();